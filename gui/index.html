<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>ExoMy Control Center</title>
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico"> 
  <script type="text/javascript" src="./roslib.min.js"></script>
  <script src="./node_modules/nipplejs/dist/nipplejs.js"></script>
  <script src="./gauge.min.js"></script>
  <script type="text/javascript">
    var publishImmidiately = true;
    var host_url = window.location.hostname;
    console.log(host_url);
    var watchdog_handle;

    var ros = new ROSLIB.Ros({
      url: 'ws://' + host_url + ':9090'
    });

    // Initialize Axes and Buttons arrays
    var axes = [0, 0, 0, 0, 0, 0];
    var buttons = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

	/*
    ros.on('connection', function () {
      document.getElementById("status").innerHTML = "Connected";
    });

    ros.on('error', function (error) {
      document.getElementById("status").innerHTML = "Error";
    });

    ros.on('close', function () {
      document.getElementById("status").innerHTML = "Closed";
    });
	*/
	
	ros.on('connection', function() {
	    console.log('Connected to websocket server.');
	});

	ros.on('error', function(error) {
	    console.log('Error connecting to websocket server: ', error);
	});

	ros.on('close', function() {
	    console.log('Connection to websocket server closed.');
	});

    createJoystick = function () {
      var options = {
        zone: document.getElementById('joy_container'),
        threshold: 0.1,
        position: { left: '50%', top: '50%' },
        mode: 'static',
        size: 150,
        color: 'black'
      };
      manager = nipplejs.create(options);

      self.manager.on('start', function (event, nipple) {
      });

      self.manager.on('move', function (event, nipple) {
        var max_distance = 75;
        var x = -Math.cos(nipple.angle.radian) * nipple.distance / max_distance;
        var y = Math.sin(nipple.angle.radian) * nipple.distance / max_distance;
        axes = [x, y, 0, 0, 0, 0]

        // nipplejs is triggering events when joystick moves each pixel
        // we need delay between consecutive messege publications to 
        // prevent system from being flooded by messages
        // events triggered earlier than 50ms after last publication will be dropped 

        if (publishImmidiately) {
          publishImmidiately = false;
          joy_event()
          window.clearInterval(watchdog_handle)
          watchdog_handle = window.setInterval(joy_event, 50)

          setTimeout(function () {
            publishImmidiately = true;
          }, 50);
        }
        //joy_event()
        //window.clearInterval()
        //window.setInterval(joy_event, 500)
      });

      self.manager.on('end', function () {
        window.clearInterval(watchdog_handle)
        axes = [0, 0, 0, 0, 0, 0]
        joy_event()
        console.log('End function called')
      });
    }
    window.onload = function () {
		joy_event();	
      	createJoystick();
		// Video output
      	stream_url = '//' + host_url + ':8080/stream?topic=/pi_cam/image_raw';
      	console.log(stream_url);
      	document.getElementById("video_output").src = stream_url;
      	// Ping output
	  	// Load a ping image to check if system server is running 
      	ping_url = 'http://' + host_url + ':8001/ping.png';
      	console.log(ping_url);
      	document.getElementById("ping").src = ping_url;
	  	document.getElementById('camera_position_slider').value = 0;
	  	move_camera();
	  	document.getElementById('heading_slider').value = 0;
		document.getElementById('heading_diff_slider').value = 0;
	  	new_heading(false);
    }

    joy_listener = new ROSLIB.Topic({
      ros: ros,
      name: "/joy",
      messageType: 'sensor_msgs/Joy'
    });

    joy_event = function () {
      var joy = new ROSLIB.Message({
        axes: axes,
        buttons: buttons
      });
      joy_listener.publish(joy);
      console.log(axes)
      console.log(buttons)
    }

     button_clicked = function (button_index) {
      // The desired button index can be found by listening to the /joy ros message
      // or by checking in the wiki for the gamepad mapping.
      // Set axes to 0 to prevent driving during mode change.
      axes = [0, 0, 0, 0, 0, 0];
      buttons[button_index] = 1;
      joy_event();
      // After the command is sent set the index back to 0
      buttons[button_index] = 0;
    }
	
	var motor_listener = new ROSLIB.Topic({
    	ros: ros,
		name: '/rover_command',
		messageType: 'exomy/RoverCommand'
	});
		
	motor_listener.subscribe(function(message) {
    	//console.log('Received message on ' + motor_listener.name + ': ' + message.motors_enabled);
		if (message.motors_enabled === true) {
			document.getElementById("buttonStart").innerHTML = "Turn MOTORS OFF";
			document.getElementById("buttonStart").style.backgroundColor = "red";
		}
		else {
			document.getElementById("buttonStart").innerHTML = "Turn MOTORS ON";
			document.getElementById("buttonStart").style.backgroundColor = "green";
		}
	});


	var bearing_listener = new ROSLIB.Topic({
    	ros: ros,
		name: '/bearing',
		messageType: 'exomy/Compass'
	});
	
	bearing_listener.subscribe(function(message) {
    	// console.log('Received message on ' + bearing_listener.name + ': ' + message.bearing);
		var gaugeElement = document.getElementsByTagName('canvas')[0];
		gaugeElement.setAttribute('data-value', message.bearing);
		document.getElementById('heading_slider').value = round5(message.bearing);
	});
	
    round5 = function (x) {
        return (x % 5) >= 2.5 ? parseInt(x / 5) * 5 + 5 : parseInt(x / 5) * 5;
    }

	/* Camera position */
	var camera_position = new ROSLIB.Topic({
		ros : ros,
		name : '/servo_commands',
		messageType : 'exomy/ServoCommands'
	});
	
	move_camera = function () {
	    // Initialize Axes and Buttons arrays
		// alert(document.getElementById("camera_position_slider").value);
	    var camera = [0];
		camera = [parseInt(document.getElementById("camera_position_slider").value), 0, 0, 0];
		var twist = new ROSLIB.Message({servo_angles : camera});
		camera_position.publish(twist);
	}
	
	/* Screen state */
	var screen_state = new ROSLIB.Topic({
		ros : ros,
		name : '/state',
		messageType : 'exomy/Screen'
	});
	
	send_mood = function (mood) {
		console.log('Mood: ' + mood);
		var mood_state = new ROSLIB.Message({state : mood});
		screen_state.publish(mood_state);
	}
	
	/* Screen message */
	var screen_message = new ROSLIB.Topic({
		ros : ros,
		name : '/screen_message',
		messageType : 'exomy/Screen'
	});
	
	talk = function () {
		screen_message_text = document.getElementById("screen_text").value;
		console.log('Screen Message: ' + screen_message_text);
		var screen_message = new ROSLIB.Message({screen_message : screen_message_text});
		screen_state.publish(screen_message);
	}


	/* Auto navigation */
	var auto_navigation = new ROSLIB.Topic({
		ros : ros,
		name : '/navigation_command',
		messageType : 'exomy/NavigationCommand'
	});
	
	new_heading = function (auto) {
		var heading = 0;
		heading_var = parseInt(document.getElementById("heading_slider").value);
		if (auto === true) {
			var heading_message = new ROSLIB.Message({auto_navigation: true, heading : heading_var});
		}
		else {
			var heading_message = new ROSLIB.Message({auto_navigation: false, heading : heading_var});
		}
		auto_navigation.publish(heading_message);
	}
	
	new_heading_diff = function (auto) {
		var heading = 0;
		var bearing = 0;
		
		var gaugeElement = document.getElementsByTagName('canvas')[0];
		bearing = gaugeElement.getAttribute('data-value');
		// console.log('Bearing: ' + bearing);
		heading_diff = parseInt(document.getElementById("heading_diff_slider").value);
		// console.log('heading_diff: ' + heading_diff);
		heading_var = parseInt(bearing) + heading_diff;
		// console.log('heading_var: ' + heading_var);
		if (heading_var > 360) {
			heading_var = heading_var - 360;
		}
		if (heading_var < 0) {
			heading_var = heading_var + 360;
		} 
		// console.log('heading_var: ' + heading_var);
		// heading_var = parseInt(heading_var);
		
		if (auto === true) {
			var heading_message = new ROSLIB.Message({auto_navigation: true, heading : heading_var});
		}
		else {
			var heading_message = new ROSLIB.Message({auto_navigation: false, heading : heading_var});
		}
		document.getElementById('heading_diff_slider').value = 0;
		auto_navigation.publish(heading_message);
	}

	// Load Shutdown URL from system server and trigger therfore the defined shutdown
	shutdownrpi = function () {
		var answer = window.confirm("Shutdown ExoMy?");
		if (answer) {
			var surl= 'http://' + host_url + ':8001/shutdown'

			console.log("Shuting down started...");
			const Http = new XMLHttpRequest();
			Http.open("GET", surl);
			Http.send();

			Http.onreadystatechange = (e) => {
				console.log(Http.responseText);
				console.log("Shutdown OK!");
			}
			alert("ExoMy shuting down safely...")
		}
		else {
		    // alert("Shutdown aborted!")
		}
	
	}
	
	// Show and Hide elements by ID
	function showOrHide(id) {
	      var element = document.getElementById(id);
	      if (element.style.display === "none") {
	         element.style.display = "block";
	      }
		  else {
	         element.style.display = "none";
	      }
	   }
	
  </script>

  <link rel="stylesheet" type="text/css" href="style.css">

</head>

<body>
  <main>
    <div class="wrapper">
      <div class="left" id="left">
        <div class="joy_container" id="joy_container"></div>
		<div class="control_container" id="control_container">
			<!--Camera position:
			<select id="camera_position" onchange="move_camera()">
				<option value="45">Up</option>
				<option value="0" selected>Straight</option>
				<option value="-45">Down</option>
			</select>
			-->
			<div class="camera_position" style="font-size:12px;">
				<label for="camera_position_slider">Camera position:</label></br>
			    <div>-45° <input id="camera_position_slider" type="range" min="-45" max="50" value="0" onchange="move_camera()"> +50°</div>
				<label for="heading_slider">Set Heading:</label></br>
				<div>0° <input id="heading_slider" type="range" min="0" max="359" value="0" onchange="new_heading(true)"> +360°</div>
				<label for="heading_diff_slider">Turn by degree:</label></br>
				<div>-180° <input id="heading_diff_slider" type="range" min="-179" max="179" value="0" onchange="new_heading_diff(true)"> +180°</div>
				<div>
					Mood:
					<span id="mood_happy" onclick="send_mood('happy')" style="font-size:20px;">&#128512;</span>
					<span id="mood_surprised" onclick="send_mood('surprised')" style="font-size:20px;">&#128562;</span>
					<span id="mood_half_closed" onclick="send_mood('half_closed')" style="font-size:20px;">&#128528;</span>
					<span id="mood_closed" onclick="send_mood('closed')" style="font-size:20px;">&#128566;</span>
					<span id="mood_kiss" onclick="send_mood('kiss')" style="font-size:20px;">&#128536;</span>
				</div>
				<div><input id="screen_text" type="text" maxlength="70"><input type="submit" value="Talk!" onclick="talk()"></div>
			</div>
		</div>
      </div>

      <div class="middle" id="middle">
        <div class="image_container">
          <img id="video_output" style="object-fit:cover; width:100%;"></img>
        </div>
		
		<div class="gauge">
		<canvas data-type="radial-gauge"
		        data-width="200"
		        data-height="200"
		        data-min-value="0"
		        data-max-value="360"
		        data-major-ticks="N,NE,E,SE,S,SW,W,NW,N"
		        data-minor-ticks="22"
		        data-ticks-angle="360"
		        data-start-angle="180"
		        data-stroke-ticks="false"
		        data-highlights="false"
		        data-color-plate="#33a"
		        data-color-major-ticks="#f5f5f5"
		        data-color-minor-ticks="#ddd"
		        data-color-numbers="#ccc"
		        data-color-needle="rgba(240, 128, 128, 1)"
		        data-color-needle-end="rgba(255, 160, 122, .9)"
		        data-value-box="true"
		        data-animated-value="true"
		        data-value-text-shadow="false"
		        data-color-circle-inner="#fff"
		        data-color-needle-circle-outer="#ccc"
		        data-needle-circle-size="15"
		        data-needle-circle-outer="false"
		        data-animation-rule="linear"
		        data-needle-type="line"
		        data-needle-start="75"
		        data-needle-end="99"
		        data-needle-width="3"
		        data-borders="true"
		        data-border-inner-width="0"
		        data-border-middle-width="0"
		        data-border-outer-width="10"
		        data-color-border-outer="#ccc"
		        data-color-border-outer-end="#ccc"
		        data-color-needle-shadow-down="#222"
		        data-border-shadow-width="0"
		        data-animation-target="plate"
		        data-units="ᵍ"
		        data-title="DIRECTION"
		        data-font-title-size="19"
		        data-color-title="#f5f5f5"
		        data-animation-duration="1500"
		        data-value="0"
		        data-animate-on-init="true"
		        data-use-min-path="true"
		        ></canvas>
			</div>
      </div>
      <div class="right" id="right">
        <div class="button_container">
          <button class="button buttonY" onclick="button_clicked(3)">CRABBING</button>
          <button class="button buttonX" onclick="button_clicked(0)">SPOT TURN</button>
          <button class="button buttonA" onclick="button_clicked(1)">ACKERMANN</button>
          <button id="buttonStart" class="button buttonStart" onclick="button_clicked(9)">MOTORS OFF/ON</button>
          <button id="shutdown" class="button buttonShutdown" onclick="shutdownrpi()">Shutdown</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Load a ping image to check if system server is running and hide shutdown button if not, as it would not work -->
  <img id="ping" class="hidden" width="1" height="1" onerror="showOrHide('shutdown');"/>

</body>
</html>
